<!DOCTYPE HTML>
<html>
    <head>
        <title>Atividade - DS | OPÇÃO 3 (INDIVIDUAL)</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <link rel="stylesheet" href="../assets/css/main.css" />
        <style>
            #frame {
                width: 100%;
                height: 1000px;
                border: 1px solid lightgray;
                border-radius: 0.5%;
            }
        </style>
    </head>
    <body class="is-preload">

        <!-- Header -->

        <!-- Main -->
        <div id="main">

            <!-- One -->
            <section id="one">
                <header class="major">
                    <h2>Atividade - OUTUBRO - 2º quinzena</h2>
                </header>
                <p>Pesquisar e Implementar um exemplo de uso do ajax, como forma de realizar envio ou recebimento de dados sem refesh (atualização) da página<br>HTML + CSS + PHP + JS + AJAX</p>
                <ul class="actions">
                    <li><a href="../" class="button">Voltar</a></li>
                </ul>
            </section>

            <!-- CÓDIGO -->

            <section id="five">
                <section>
                    <h4>HTML</h4>
                    <pre id="code_html">
                        <code>&lt;!DOCTYPE HTML&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;teste&lt;/title&gt;
        &lt;meta charset="utf-8" /&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;
        &lt;link rel="stylesheet" href="../assets/css/main.css" /&gt;
        &lt;style&gt;
            #frame {
                width: 100%;
                height: 1000px;
            }
        &lt;/style&gt;
    &lt;/head&gt;
    &lt;body class="is-preload"&gt;
        &lt;div id="main"&gt;
            &lt;section id="one"&gt;
                &lt;h2&gt;FORMULÁRIO&lt;/h2&gt;
                &lt;section&gt;
                    &lt;h4&gt;Insira as informações e clique em ENVIAR&lt;/h4&gt;
                    &lt;form action="https://mpsilva.000webhostapp.com/webservice/salva.php" method="post" enctype="multipart/form-data" id="form"&gt;
                        &lt;div class="row gtr-uniform gtr-50"&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="text" name="nome" id="demo-name" value="" placeholder="NOME" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="text" name="profissao" id="demo-name" value="" placeholder="PROFISSÃO" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="text" name="email" id="demo-name" value="" placeholder="EMAIL" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="text" name="cidade" id="demo-name" value="" placeholder="CIDADE" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12"&gt;
                                &lt;select name="uf" id="demo-category" title="Selecione o estado" required &gt;
                                    &lt;option value="-"&gt;-&lt;/option&gt;
                                    &lt;option value="AC"&gt;AC&lt;/option&gt;
                                    &lt;option value="AL"&gt;AL&lt;/option&gt;
                                    &lt;option value="AP"&gt;AP&lt;/option&gt;
                                    &lt;option value="AM"&gt;AM&lt;/option&gt;
                                    &lt;option value="BA"&gt;BA&lt;/option&gt;
                                    &lt;option value="CE"&gt;CE&lt;/option&gt;
                                    &lt;option value="DF"&gt;DF&lt;/option&gt;
                                    &lt;option value="ES"&gt;ES&lt;/option&gt;
                                    &lt;option value="GO"&gt;GO&lt;/option&gt;
                                    &lt;option value="MA"&gt;MA&lt;/option&gt;
                                    &lt;option value="MT"&gt;MT&lt;/option&gt;
                                    &lt;option value="MS"&gt;MS&lt;/option&gt;
                                    &lt;option value="MG"&gt;MG&lt;/option&gt;
                                    &lt;option value="PA"&gt;PA&lt;/option&gt;
                                    &lt;option value="PB"&gt;PB&lt;/option&gt;
                                    &lt;option value="PR"&gt;PR&lt;/option&gt;
                                    &lt;option value="PE"&gt;PE&lt;/option&gt;
                                    &lt;option value="PI"&gt;PI&lt;/option&gt;
                                    &lt;option value="RJ"&gt;RJ&lt;/option&gt;
                                    &lt;option value="RN"&gt;RN&lt;/option&gt;
                                    &lt;option value="RS"&gt;RS&lt;/option&gt;
                                    &lt;option value="RO"&gt;RO&lt;/option&gt;
                                    &lt;option value="RR"&gt;RR&lt;/option&gt;
                                    &lt;option value="SC"&gt;SC&lt;/option&gt;
                                    &lt;option value="SP"&gt;SP&lt;/option&gt;
                                    &lt;option value="SE"&gt;SE&lt;/option&gt;
                                    &lt;option value="TO"&gt;TO&lt;/option&gt;
                                &lt;/select&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="number" name="idade" id="demo-name" value="" placeholder="IDADE" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="date" name="dt_nascimento" id="demo-name" value="" placeholder="DATA DE NASCIMENTO" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;input type="text" name="telefone" id="demo-name" value="" placeholder="TELEFONE" required /&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12 col-12-xsmall"&gt;
                                &lt;label for="foto" class="btn btn-light shadow foto_btn primary" id="demo-name"&gt;&lt;i class="fa fa-file-image-o" aria-hidden="true"&gt;&lt;/i&gt; Selecione a sua foto&lt;/label&gt;
                                &lt;input type="file" id="foto" name="imagem" class="form-control col-12" style=""&gt;
                                &lt;input type="hidden" name="foto_id" class="form-control col-12"&gt;
                                &lt;input type="hidden" name="user_id" class="form-control col-12"&gt;
                            &lt;/div&gt;
                            &lt;div class="col-12"&gt;
                                &lt;ul class="actions"&gt;
                                    &lt;li&gt;&lt;input type="submit" value="Cadastrar" class="primary" /&gt;&lt;/li&gt;
                                &lt;/ul&gt;
                            &lt;/div&gt;
                        &lt;/div&gt;
                    &lt;/form&gt;
                &lt;/section&gt;
            &lt;/section&gt;
            &lt;section id="four"&gt;
                &lt;h2&gt;PESSOAS&lt;/h2&gt;
                &lt;section&gt;
                    &lt;div class="table-wrapper"&gt;
                        &lt;table class="alt"&gt;&lt;hr&gt;
                            &lt;thead&gt;
                                &lt;tr&gt;
                                    &lt;th&gt;nome&lt;/th&gt;
                                    &lt;th&gt;profissão&lt;/th&gt;
                                    &lt;th&gt;email&lt;/th&gt;
                                    &lt;th&gt;cidade&lt;/th&gt;
                                    &lt;th&gt;idade&lt;/th&gt;
                                    &lt;th&gt;telefone&lt;/th&gt;
                                &lt;/tr&gt;
                            &lt;/thead&gt;
                            &lt;tbody id="lista_pessoas"&gt;
                            &lt;/tbody&gt;
                        &lt;/table&gt;
                    &lt;/div&gt;
                &lt;/section&gt;
            &lt;/section&gt;
        &lt;/div&gt;
        &lt;script type="text/javascript" src="source/jquery-3.5.1.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="source/jquery.form.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="source/jquery.mask.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="js/bootstrap.min.js"&gt;&lt;/script&gt;
        &lt;script type="text/javascript" src="source/jquery-dateformat.min.js"&gt;&lt;/script&gt;
        &lt;script src="../assets/js/jquery.poptrox.min.js"&gt;&lt;/script&gt;
        &lt;script src="../assets/js/browser.min.js"&gt;&lt;/script&gt;
        &lt;script src="../assets/js/breakpoints.min.js"&gt;&lt;/script&gt;
        &lt;script src="../assets/js/util.js"&gt;&lt;/script&gt;
        &lt;script src="../assets/js/main.js"&gt;&lt;/script&gt;
        &lt;script src="source/script.js"&gt;&lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code>
                    </pre>
                    <h4>CSS</h4>
                    <pre id="code_css">
                        <code></code>
                    </pre>
                    <h4>JS</h4>
                    <pre id="code_js">
                        <code></code>
                    </pre>
                    <h4>PHP</h4>
                    <pre id="code_php">
                        <code>&lt;?php
    error_reporting(E_ALL);
    ini_set('display_errors', 'On');
    header('Access-Control-Allow-Origin: *');
    date_default_timezone_set("America/Sao_Paulo");
    $con = new mysqli("*****", "*****", "*****", "*****");
    $con->query("SET NAMES 'utf8'");
    $con->query("SET character_set_connection=utf8");
    $con->query("SET character_set_client=utf8");
    $con->query("SET character_set_results=utf8");

    function retorno($msg) {
        $retorno = array();
        $retorno["mensagem"] = $msg;
        return json_encode($retorno);
    }

    function CadastrarArquivo($nome, $tipo, $link, $tamanho) {
        $stmt = $GLOBALS["con"]->prepare("SELECT CadastrarArquivo(?,?,?,?) AS mensagem");
        $cdata = file_get_contents($link);
        $ctamanho = round((($tamanho / 1024) / 1024), 2);
        echo $GLOBALS["con"]->error;
        $stmt->bind_param("ssdb", $nome, $tipo, $ctamanho, $cdata);
        $stmt->send_long_data(3, $cdata);
        $stmt->execute();
        if ($stmt) {
            $stmt->bind_result($alert);
            while ($stmt->fetch()) {
               return $alert;
            }
        } else {
            return "Erro ao CADASTRAR!";
        }
    }

    function CadastrarUsuario($nome, $profissao, $email, $cidade, $uf, $idade, $dt_nasc, $telefone, $foto) {
        $foto_id = null;
        $stmt = $GLOBALS["con"]->prepare("SELECT IDArquivo(?) AS foto_id");
        $stmt->bind_param("s", $foto);
        $stmt->execute();
        if ($stmt) {
            $stmt->bind_result($sum);
            while ($stmt->fetch()) {
               $foto_id = $sum;
            }
        } else {
            $foto_id = null;
        }
        $stmt2 = $GLOBALS["con"]->prepare("SELECT CadastrarUsuario(?, ?, ?, ?, ?, ?, ?, ?, ?) AS mensagem");
        $data_nasc = @date("Y-m-d", strtotime($dt_nasc));
        $stmt2->bind_param("sssssissi", $nome, $profissao, $email, $cidade, $uf, $idade, $data_nasc, $telefone, $foto_id);
        $stmt2->execute();
        echo $GLOBALS["con"]->error;
        if ($stmt2) {
            $stmt2->bind_result($alert);
            while ($stmt2->fetch()) {
               return $alert;
            }
        } else {
            return mysqli_error($GLOBALS["con"]);
        }
    }

    function CadastrarUsuarioSFT($nome, $profissao, $email, $cidade, $uf, $idade, $dt_nasc, $telefone) {
        $stmt = $GLOBALS["con"]->prepare("SELECT CadastrarUsuario(?, ?, ?, ?, ?, ?, ?, ?, ?) AS mensagem");
        $data_nasc = @date("Y-m-d", strtotime($dt_nasc));
        $foto_id = null;
        $stmt->bind_param("sssssissi", $nome, $profissao, $email, $cidade, $uf, $idade, $data_nasc, $telefone, $foto_id);
        $stmt->execute();
        if ($stmt) {
            $stmt->bind_result($alert);
            while ($stmt->fetch()) {
               return $alert;
            }
        } else {
            return mysqli_error($GLOBALS["con"]);
        }
    }

    if (isset($_FILES["imagem"])) {
        $cnome = strtolower(str_replace(" ", "-", $_POST["nome"]) . "." . explode("/", $_FILES["imagem"]["type"])[1]);
        echo retorno(CadastrarArquivo($cnome, $_FILES["imagem"]["type"], $_FILES["imagem"]["tmp_name"], $_FILES["imagem"]["size"]) . " - " . CadastrarUsuario($_POST["nome"], $_POST["profissao"], $_POST["email"], $_POST["cidade"], $_POST["uf"], $_POST["idade"], $_POST["dt_nascimento"], $_POST["telefone"], $cnome));
    } else {
        echo retorno(CadastrarUsuarioSFT($_POST["nome"], $_POST["profissao"], $_POST["email"], $_POST["cidade"], $_POST["uf"], $_POST["idade"], $_POST["dt_nascimento"], $_POST["telefone"]));
    }

    $res = $con->query("SELECT u.*, a.tipo, TO_BASE64(a.conteudo) AS conteudo FROM usuario u LEFT OUTER JOIN arquivo a ON (u.foto_id = a.id) WHERE a.id IS NULL OR a.id = u.foto_id;");
    if ($res) {
        $users = array();
        while ($user = $res->fetch_array(MYSQLI_ASSOC)) {
            $user["dt_nascimento"] = @date("d/m/Y", strtotime($user["dt_nascimento"]));
            array_push($users, $user);
        }
        echo json_encode($users);
    } else {
        echo mysqli_error($con);
    }

    function ExcluirUsuario($usuario_id, $foto_id) {
        $stmt = $GLOBALS["con"]->prepare("SELECT ExcluirUsuario(?) AS mensagem");
        $stmt->bind_param("i", $usuario_id);
        $stmt->execute();
        
        $confU = "";

        if ($stmt) {
            $stmt->bind_result($alert);
            while ($stmt->fetch()) {
               $confU = $alert;
            }
        } else {
            $confU = "Erro ao EXCLUIR!";
        }
        
        $stmt = $GLOBALS["con"]->prepare("SELECT ExcluirArquivo(?) AS mensagem");
        $stmt->bind_param("i", $foto_id);
        $stmt->execute();
        
        $confA = "";

        if ($stmt) {
            $stmt->bind_result($alert);
            while ($stmt->fetch()) {
               $confA = $alert;
            }
        } else {
            $confA = "Erro ao EXCLUIR!";
        }
        
        return $confU . " - " . $confA;
    }

    function ExcluirUsuarioSFT($usuario_id) {
        $stmt = $GLOBALS["con"]->prepare("SELECT ExcluirUsuario(?) AS mensagem");
        $stmt->bind_param("i", $usuario_id);
        $stmt->execute();

        if ($stmt) {
            $stmt->bind_result($alert);
            while ($stmt->fetch()) {
               return $alert;
            }
        } else {
            return "Erro ao EXCLUIR!";
        }
    }

    $retorno = array();

    if (isset($_POST["fotoId"])) {
        $retorno["mensagem"] = ExcluirUsuario($_POST["usuarioId"], $_POST["fotoId"]);
    } else {
        $retorno["mensagem"] = ExcluirUsuarioSFT($_POST["usuarioId"]);
    }

    echo json_encode($retorno);
?&gt;</code>
                    </pre>
                    <h4>RESULTADO: </h4>
                    <section>
                        <iframe id="frame" src="example.html"></iframe>
                    </section>
                </section>
            </section>
        </div>

        <!-- Footer -->


        <!-- Scripts -->
        <script src="../assets/js/jquery.min.js"></script>
        <script src="../assets/js/jquery.poptrox.min.js"></script>
        <script src="../assets/js/browser.min.js"></script>
        <script src="../assets/js/breakpoints.min.js"></script>
        <script src="../assets/js/util.js"></script>
        <script src="../assets/js/main.js"></script>

        <script>
            
            $.ajax({
                url: "../assets/css/main.css",
                dataType: "text",
                success: function (data) {
                    $("#code_css code").html(data);
                }
            });

            $.ajax({
                url: "source/script.js",
                dataType: "text",
                success: function (data) {
                    $("#code_js code").html(data);
                }
            });
        </script>
    </body>
</html>